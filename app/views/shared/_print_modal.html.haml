.modal-dialog.modal-lg
  .modal-content
    - formurl = print_url_by_entity(entity)
    - formid = "print_form_#{entity.class.name.downcase}_#{entity.id}"
    = form_tag(formurl, method: :get, id: formid, target: '_blank') do
      .flex-popup{style: 'height: 75vh;'}
        .modal-header
          .popup-top
            %button.btn-small-outline-v02{'data-dismiss'=>'modal'}
              .btn-text-v02
                %span.right-arrow 2
                %span= t(:back)
            .headline-2-v02{:style => "text-align: center;margin: 0; padding-top: 3px;"}= t(:print)
            .button-placeholder
        .modal-body
          .by-popup-v02{style: 'height: 100%; display: flex; flex-direction: column;'}
            .by-card-header-v02.desktop-only
              %span.headline-1-v02= t(:print)
              %a.popup-x-v02.linkcolor.pointer{'data-dismiss'=>'modal'} -
            .by-card-content-v02{style: 'overflow-y: auto; flex: 1 1 auto;'}
              - if entity.is_a?(Collection)
                %p= t(:print_choose_scope)
                .search-mobile-switch
                  %button.search-mobile-option.active{type: 'button', 'data-scope' => 'full'}= t(:full_collection)
                  %button.search-mobile-option{type: 'button', 'data-scope' => 'partial'}= t(:selected_items)

                #print-manifestation-selection-area{style: 'display: none;'}
                  .headline-3-v02
                    = t(:items_to_print)
                    %span#print-selected-count 0
                  .field-v02.texts-list{style: 'height: auto;'}
                    .select-all-with-buttons
                      .select-text-checkbox-area
                        .select-all-checkbox
                          %input#print-select-all-checkbox{type: 'checkbox', value: 'selectall'}
                      .headline-3-v02= t(:included_items)
                    .mainlist.multiselect#texts-to-print{style: 'max-height: 40vh; overflow-y: auto; overflow-x: hidden;'}
                      %ol
                        - entity.flatten_items.select { |ci| ci.item_type == 'Manifestation' && ci.item.present? }.each do |ci|
                          %li
                            %input.print-multiselect_checkbox{type: 'checkbox', name: 'manifestation_ids[]', value: ci.item_id}
                            - author_names = ci.involved_authorities.select { |ia| ia.role == 'author' }.map { |ia| ia.authority.name }.join(', ')
                            - text = author_names.present? ? "#{ci.title} / #{author_names}" : ci.title
                            = text

              = hidden_field_tag 'print_scope', 'full', id: 'print_scope'
            .bottom-button-area.left-buttons{style: 'flex: 0 0 auto; margin-top: auto;'}
              .desktop-only.linkcolor.pointer{'data-dismiss'=>'modal'}
                %span.right-side-icon -
                %span{:style => "font-weight: bold"}= t(:cancel)
              = submit_tag t(:print_full_collection), {class: 'pointer by-button-v02 link-to-all-v02 print_submitter', id: 'print_do_print'}

:javascript
  $(document).ready(function(){
    var formid = "##{formid}";
    var dlgid = "#printDlg";

    // Handle scope toggle
    $('.search-mobile-switch button', dlgid).click(function() {
      $(this).siblings().removeClass('active');
      $(this).addClass('active');

      var scope = $(this).data('scope');
      $('#print_scope').val(scope);

      if (scope === 'partial') {
        $('#print-manifestation-selection-area').show();
        updatePrintButton();
      } else {
        $('#print-manifestation-selection-area').hide();
        $('#print_do_print').text("#{t(:print_full_collection)}");
      }
    });

    // Handle select all checkbox
    $('#print-select-all-checkbox').change(function() {
      $('.print-multiselect_checkbox').prop('checked', this.checked);
      updatePrintButton();
    });

    // Handle individual checkbox changes
    $('.print-multiselect_checkbox').change(function() {
      updatePrintButton();

      // Update select-all checkbox state
      var allChecked = $('.print-multiselect_checkbox').length === $('.print-multiselect_checkbox:checked').length;
      $('#print-select-all-checkbox').prop('checked', allChecked);
    });

    function updatePrintButton() {
      var count = $('.print-multiselect_checkbox:checked').length;
      $('#print-selected-count').text(count);

      if (count > 0) {
        // Hebrew: "הדפסת X יצירות שנבחרו"
        var buttonText = '#{I18n.locale}' === 'he' ?
          "הדפסת " + count + " יצירות שנבחרו" :
          "Print " + count + " selected items";
        $('#print_do_print').text(buttonText);
      } else {
        $('#print_do_print').text("#{t(:print_full_collection)}");
      }
    }

    $(formid).on('submit', function() {
      // Hide modal after a short delay to allow form submission to complete
      setTimeout(function() {
        $(dlgid).modal('hide');
      }, 300);
    });
  });
