-# KWIC Concordance Browser
-# Shared partial for both Manifestations and Collections
-# Parameters:
-#   @entity - The Manifestation or Collection object
-#   @entity_type - 'Manifestation' or 'Collection'
-#   @concordance_entries - Array of concordance entries for current page
-#   @total_entries - Total number of concordance entries
-#   @page - Current page number
-#   @total_pages - Total number of pages
-#   @per_page - Entries per page
-#   @filter_text - Current filter text

.container-fluid.kwic-browser
  .row
    .col-md-12
      .by-card-v02
        .work-area
          .work-content
            .headline-1-v02= t(:kwic_browser_title)
            
            -# Filter and pagination controls
            .kwic-controls.mb-4
              .row
                .col-md-6
                  = form_tag '', method: :get, class: 'kwic-filter-form' do
                    .input-group
                      = text_field_tag :filter, @filter_text, 
                          class: 'form-control', 
                          placeholder: t(:kwic_filter_placeholder),
                          dir: 'rtl'
                      = hidden_field_tag :per_page, @per_page
                      = hidden_field_tag :sort, @sort_by
                      .input-group-append
                        = submit_tag t(:search), class: 'btn btn-primary'
                        - if @filter_text.present?
                          = link_to t(:clear), url_for(filter: nil, per_page: @per_page, sort: @sort_by), class: 'btn btn-secondary'
                
                .col-md-6.text-left
                  .per-page-selector
                    = t(:kwic_entries_per_page) + ': '
                    - [25, 50, 100].each do |count|
                      - if count == @per_page
                        %strong= count
                      - else
                        = link_to count, url_for(per_page: count, filter: @filter_text, sort: @sort_by, page: 1)
                      &nbsp;
            
            -# Sort controls
            .kwic-sort-controls.mb-3
              .row
                .col-md-12.text-left
                  %span= t(:kwic_sort_by)
                  &nbsp;
                  - if @sort_by == 'alphabetical'
                    %strong= t(:kwic_sort_alphabetical)
                  - else
                    = link_to t(:kwic_sort_alphabetical), url_for(sort: 'alphabetical', filter: @filter_text, per_page: @per_page, page: 1)
                  &nbsp;|&nbsp;
                  - if @sort_by == 'frequency'
                    %strong= t(:kwic_sort_frequency)
                  - else
                    = link_to t(:kwic_sort_frequency), url_for(sort: 'frequency', filter: @filter_text, per_page: @per_page, page: 1)
            
            -# Results info
            .kwic-info.mb-3
              %p
                = t(:kwic_total_entries)
                %strong= @total_entries
                - if @total_pages && @total_pages > 0
                  |
                  = t(:kwic_showing_page, page: @page, total: @total_pages)
            
            -# Download buttons
            .kwic-downloads.mb-4
              - download_path = if @filter_text.present?
                - case @entity_type
                  - when 'Manifestation'
                    - manifestation_kwic_download_path(@entity, filter: @filter_text)
                  - when 'Collection'
                    - collection_kwic_download_path(collection_id: @entity, filter: @filter_text)
                  - when 'Authority'
                    - author_kwic_download_path(id: @entity, filter: @filter_text)
              - else
                - case @entity_type
                  - when 'Manifestation'
                    - manifestation_kwic_download_path(@entity)
                  - when 'Collection'
                    - collection_kwic_download_path(collection_id: @entity)
                  - when 'Authority'
                    - author_kwic_download_path(id: @entity)
              = link_to (@filter_text.present? ? t(:kwic_download_filtered) : t(:kwic_download_full)), download_path, class: 'btn btn-success'
            
            -# Concordance entries
            .kwic-entries
              - if @concordance_entries.empty?
                .alert.alert-info
                  = t(:no_results)
              - else
                - @concordance_entries.each_with_index do |entry, entry_idx|
                  .kwic-entry.mb-4{data: { token: entry[:token] }}
                    .kwic-token.mb-2
                      %h4
                        = t(:kwic_token)
                        %strong= entry[:token]
                        %small.text-muted= "(#{entry[:instances].length})"
                    
                    .kwic-instances
                      - entry[:instances].each_with_index do |instance, inst_idx|
                        - instance_id = "kwic-instance-#{@page}-#{entry_idx}-#{inst_idx}"
                        .kwic-instance.mb-2.p-2{style: 'border-right: 3px solid #ddd;'}
                          .kwic-context{dir: 'rtl'}
                            %span.before-context= instance[:before_context]
                            %strong.token-highlight{style: 'background-color: #ffeb3b; padding: 2px 4px;'}= entry[:token]
                            %span.after-context= instance[:after_context]
                          
                          .kwic-meta.mt-1{style: 'font-size: 0.9em;'}
                            %span.text-muted
                              = instance[:label]
                              |
                              = t(:kwic_paragraph)
                              = instance[:paragraph]
                            
                            .kwic-actions.mt-1
                              - if @entity_type == 'Manifestation'
                                = link_to t(:kwic_go_to_source), 
                                    manifestation_path(@entity),
                                    class: 'btn btn-sm btn-outline-primary',
                                    target: '_blank',
                                    rel: 'noopener'
                              - elsif @entity_type == 'Collection'
                                -# For collections, we need to find the source manifestation
                                - source_item = @collection_items_by_label[instance[:label]]
                                - if source_item && source_item.item
                                  = link_to t(:kwic_go_to_source),
                                      manifestation_path(source_item.item),
                                      class: 'btn btn-sm btn-outline-primary',
                                      target: '_blank',
                                      rel: 'noopener'
                              - elsif @entity_type == 'Authority'
                                -# For authorities, find manifestation by ID from enriched data
                                - if instance[:manifestation_id]
                                  = link_to t(:kwic_go_to_source),
                                      manifestation_path(instance[:manifestation_id]),
                                      class: 'btn btn-sm btn-outline-primary',
                                      target: '_blank',
                                      rel: 'noopener'
                              
                              %button.btn.btn-sm.btn-outline-secondary.show-context-btn{
                                data: { 
                                  toggle: 'collapse',
                                  target: "##{instance_id}-context",
                                  manifestation_id: instance[:manifestation_id],
                                  paragraph: instance[:paragraph],
                                  entity_type: @entity_type,
                                  token: entry[:token]
                                },
                                'aria-expanded' => 'false',
                                'aria-controls' => "#{instance_id}-context",
                                class: 'kwic-context-toggle'
                              }
                                = t(:kwic_show_context)
                          
                          -# Collapsible context panel (will be populated on expand via AJAX)
                          .collapse.mt-2{id: "#{instance_id}-context"}
                            .card.card-body{dir: 'rtl', style: 'background-color: #f9f9f9;'}
                              .context-content
                                .text-center.text-muted
                                  %em= t(:loading)
                                  %span.spinner-border.spinner-border-sm{role: 'status'}
            
            -# Pagination
            - if @total_pages > 1
              .kwic-pagination.mt-4
                %nav{'aria-label' => 'KWIC pagination'}
                  %ul.pagination.justify-content-center
                    - if @page > 1
                      %li.page-item
                        = link_to '«', url_for(page: @page - 1, per_page: @per_page, filter: @filter_text, sort: @sort_by), class: 'page-link'
                    - else
                      %li.page-item.disabled
                        %span.page-link «
                    
                    - page_range = [[@page - 2, 1].max, [@page + 2, @total_pages].min]
                    - if page_range[0] > 1
                      %li.page-item
                        = link_to '1', url_for(page: 1, per_page: @per_page, filter: @filter_text, sort: @sort_by), class: 'page-link'
                      - if page_range[0] > 2
                        %li.page-item.disabled
                          %span.page-link ...
                    
                    - (page_range[0]..page_range[1]).each do |p|
                      - if p == @page
                        %li.page-item.active
                          %span.page-link= p
                      - else
                        %li.page-item
                          = link_to p, url_for(page: p, per_page: @per_page, filter: @filter_text, sort: @sort_by), class: 'page-link'
                    
                    - if page_range[1] < @total_pages
                      - if page_range[1] < @total_pages - 1
                        %li.page-item.disabled
                          %span.page-link ...
                      %li.page-item
                        = link_to @total_pages, url_for(page: @total_pages, per_page: @per_page, filter: @filter_text, sort: @sort_by), class: 'page-link'
                    
                    - if @page < @total_pages
                      %li.page-item
                        = link_to '»', url_for(page: @page + 1, per_page: @per_page, filter: @filter_text, sort: @sort_by), class: 'page-link'
                    - else
                      %li.page-item.disabled
                        %span.page-link »

:javascript
  $(function() {
    // Track which contexts have been loaded
    var loadedContexts = {};
    
    // Function to highlight token occurrences in HTML
    function highlightToken(html, token) {
      if (!html || !token) return html;
      
      // Create a temporary div to work with the HTML
      var $temp = $('<div>').html(html);
      
      // Function to highlight text in text nodes
      function highlightInNode(node) {
        if (node.nodeType === 3) { // Text node
          var text = node.nodeValue;
          if (text && text.includes(token)) {
            // Create a span with highlighted tokens
            var span = document.createElement('span');
            var parts = text.split(token);
            
            for (var i = 0; i < parts.length; i++) {
              span.appendChild(document.createTextNode(parts[i]));
              if (i < parts.length - 1) {
                var highlight = document.createElement('span');
                highlight.className = 'token-highlight';
                highlight.style.backgroundColor = '#ffeb3b';
                highlight.style.padding = '2px 4px';
                highlight.appendChild(document.createTextNode(token));
                span.appendChild(highlight);
              }
            }
            
            node.parentNode.replaceChild(span, node);
          }
        } else if (node.nodeType === 1 && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
          // Element node - recurse through children
          var children = Array.from(node.childNodes);
          children.forEach(function(child) {
            highlightInNode(child);
          });
        }
      }
      
      highlightInNode($temp[0]);
      return $temp.html();
    }
    
    // Toggle button text and load context when shown
    $('.kwic-context-toggle').on('click', function() {
      var $btn = $(this);
      var targetId = $btn.data('target');
      var $target = $(targetId);
      var manifestationId = $btn.data('manifestationId');
      var paragraph = $btn.data('paragraph');
      var entityType = $btn.data('entityType');
      var token = $btn.data('token');
      
      setTimeout(function() {
        var isExpanded = !$target.hasClass('collapsed');
        if (isExpanded) {
          $btn.text('#{t(:kwic_hide_context)}');
          
          // Load context if not already loaded
          if (!loadedContexts[targetId]) {
            loadedContexts[targetId] = true;
            var contextUrl;
            
            if (entityType === 'Manifestation') {
              contextUrl = '/kwic/' + manifestationId + '/context/' + paragraph;
            } else if (entityType === 'Collection') {
              // For collections, we need the collection ID and manifestation ID
              var collectionId = window.location.pathname.split('/')[2];
              contextUrl = '/collections/' + collectionId + '/kwic_context/' + manifestationId + '/' + paragraph;
            } else if (entityType === 'Authority') {
              // For authorities, we need the authority ID and manifestation ID
              var authorityId = window.location.pathname.split('/')[2];
              contextUrl = '/author/' + authorityId + '/kwic/context/' + manifestationId + '/' + paragraph;
            }
            
            $.ajax({
              url: contextUrl,
              method: 'GET',
              success: function(data) {
                var html = '';
                
                if (data.prev) {
                  html += '<div class="mb-3"><strong>#{t(:kwic_previous_paragraph)}:</strong><div>' + data.prev + '</div></div>';
                }
                
                if (data.current) {
                  // Highlight the token in the current paragraph
                  var highlightedCurrent = highlightToken(data.current, token);
                  html += '<div class="mb-3"><strong>#{t(:kwic_current_paragraph)}:</strong><div>' + highlightedCurrent + '</div></div>';
                }
                
                if (data.next) {
                  html += '<div class="mb-3"><strong>#{t(:kwic_next_paragraph)}:</strong><div>' + data.next + '</div></div>';
                }
                
                $target.find('.context-content').html(html);
              },
              error: function() {
                $target.find('.context-content').html('<div class="alert alert-danger">#{t(:error_loading_context)}</div>');
              }
            });
          }
        } else {
          $btn.text('#{t(:kwic_show_context)}');
        }
      }, 350); // Wait for collapse animation
    });
  });
