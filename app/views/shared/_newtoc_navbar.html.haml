- top_nodes = @toc_tree ? @toc_tree.top_level_nodes : GenerateTocTree.call(@author).top_level_nodes

%nav.book-nav-full.by-card-v02
  .side-nav-in-page
    = t(:navigation_in_page)
  - InvolvedAuthority::ROLES_PRESENTATION_ORDER.each do |role|
    :ruby
      involved_on_collection_level = top_nodes.select { |node| node.visible?(role, authority_id, true) }
                                              .sort_by(&:sort_term)
      involved_on_work_level = top_nodes.select { |node| node.visible?(role, authority_id, false) }
                                        .sort_by(&:sort_term)
      uncollected_node = involved_on_work_level.detect { |node| node.collection.uncollected? }
      involved_on_work_level -= [uncollected_node] if uncollected_node.present?

    - role_counts = @toc_counts ? @toc_counts[role] : nil
    - if role_counts && role_counts[:total] > 0
      .nav-book-group.selected
        .headline-2-v02
          = t("toc_by_role.headers.#{role}", gender_letter: @author.gender_letter)
          - if role_counts[:total] > 0
            = " (#{role_counts[:total]})"
        - if role_counts[:collection_level] > 0
          .book-type.selected.pointer
            .truncate{'data-bs-toggle' => 'collapse', 'data-bs-target' => "#collection-#{role}-collapse"}
              = t('toc_by_role.involved_on_collection_level', gender_letter: @author.gender_letter)
              %span.count-badge= " (#{role_counts[:collection_level]})"
          %ul.collapse.navbar-nav{ id: "collection-#{role}-collapse", "aria-label" => "file-navigator", :role => "tree"}
            = render partial: 'shared/navbar/toc_node', collection: involved_on_collection_level, locals: { role: role, authority_id: authority_id, nonce: "#{role}-collection", uncollected: false, involved_on_collection_level: true }
        - if role_counts[:work_level] > 0
          .book-type.pointer
            .truncate{'data-bs-toggle' => 'collapse', 'data-bs-target' => "#work-#{role}-collapse"}
              = t('toc_by_role.involved_on_work_level')
              %span.count-badge= " (#{role_counts[:work_level]})"
          %ul.collapse.navbar-nav{ id: "work-#{role}-collapse", "aria-label" => "file-navigator", :role => "tree"}
            = render partial: 'shared/navbar/toc_node', collection: involved_on_work_level, locals: { role: role, authority_id: authority_id, nonce: "#{role}-work", uncollected: false, involved_on_collection_level: false }
        - if role_counts[:uncollected] > 0
          .book-type.pointer
            .truncate{'data-bs-toggle' => 'collapse', 'data-bs-target' => "#uncollected-#{role}-collapse"}
              = t('toc_by_role.uncollected_works')
              %span.count-badge= " (#{role_counts[:uncollected]})"
          %ul.collapse.navbar-nav{ id: "uncollected-#{role}-collapse", "aria-label" => "file-navigator", :role => "tree"}
            = render partial: 'shared/navbar/toc_node', collection: involved_on_collection_level, locals: { role: role, authority_id: authority_id, uncollected: false, involved_on_collection_level: false }

  - if @any_curated
    .nav-book-group.editorial-nav
      .headline-2-v02= t(:curated_content)
      .book-type
        .truncate עדכונים אחרונים
      .book-type
        .truncate יצירות על אודות היוצר
      .book-type
        .truncate קישורים חיצוניים
      .book-type
        .truncate המלצות קוראים
  - if @lexicon_entry.present?
    .nav-book-group.lexicon-background-color
      .headline-2-v02= t(:lexicon_content)
      .book-type
        .truncate תמצית
      .book-type
        .truncate רשימת ספרים
      .book-type
        .truncate על המחבר ויצירתו
      .book-type
        .truncate קישורים

:javascript
  $(document).ready(function() {
    $('.book-type .truncate').click(function() {
      $($(this).data('bs-target')).collapse('toggle');
    });
    $('.nav-link').click(function(e) {
      e.preventDefault();
      //$('.nav-item').removeClass('current-menu-item');
      //$(this).parent().addClass('current-menu-item');
      anchor = $(this).attr('id').replace('_button','_g');
      $('html, body').animate({
        scrollTop: $('a[name='+anchor+']').offset().top - $('#header').height() -65
      }, 800);
    }); 
  });