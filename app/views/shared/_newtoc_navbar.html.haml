- top_nodes = @toc_tree ? @toc_tree.top_level_nodes : GenerateTocTree.call(@author).top_level_nodes
- first = true
%nav.book-nav-full.by-card-v02
  .side-nav-in-page
    = t(:navigation_in_page)
  - InvolvedAuthority::ROLES_PRESENTATION_ORDER.each do |role|
    :ruby
      involved_on_collection_level = top_nodes.select { |node| node.visible?(role, authority_id, true) }
                                              .sort_by(&:sort_term)
      involved_on_work_level = top_nodes.select { |node| node.visible?(role, authority_id, false) }
                                        .sort_by(&:sort_term)
      uncollected_node = involved_on_work_level.detect { |node| node.collection.uncollected? }
      involved_on_work_level -= [uncollected_node] if uncollected_node.present?

    - role_counts = @toc_counts ? @toc_counts[role] : nil
    - if role_counts && role_counts[:total] > 0
      %div{ class: first ? "nav-book-group selected" : "nav-book-group" }
        .headline-2-v02
          = t("toc_by_role.headers.#{role}", gender_letter: @author.gender_letter)
          - if role_counts[:total] > 0
            = " (#{role_counts[:total]})"
        - if role_counts[:collection_level] > 0
          %div{ class: first ? "book-type selected pointer" : "book-type pointer" }
            .truncate{'data-bs-toggle' => 'collapse', 'data-bs-target' => "#collection-#{role}-collapse", 'data-scroll-target' => "#works-#{role}-collection-level"}
              = t('toc_by_role.involved_on_collection_level', gender_letter: @author.gender_letter)
              %span.count-badge= " (#{role_counts[:collection_level]})"
              %span.collapse-arrow ↓
          %ul{ id: "collection-#{role}-collapse", class: first ? 'collapse navbar-nav show' : 'collapse navbar-nav', "aria-label" => "file-navigator", :role => "tree"}
            = render partial: 'shared/navbar/toc_node', collection: involved_on_collection_level, locals: { role: role, authority_id: authority_id, nonce: "#{role}-collection", uncollected: false, involved_on_collection_level: true }
          - first = false
        - if role_counts[:work_level] > 0
          %div{ class: first ? "book-type selected pointer" : "book-type pointer" }
            .truncate{ 'data-bs-toggle' => 'collapse', 'data-bs-target' => "#work-#{role}-collapse", 'data-scroll-target' => "#works-#{role}-work-level" }
              = t('toc_by_role.involved_on_work_level')
              %span.count-badge= " (#{role_counts[:work_level]})"
              %span.collapse-arrow ↓
          %ul{ id: "work-#{role}-collapse", class: first ? 'collapse navbar-nav show' : 'collapse navbar-nav', "aria-label" => "file-navigator", :role => "tree" }
            = render partial: 'shared/navbar/toc_node', collection: involved_on_work_level, locals: { role: role, authority_id: authority_id, nonce: "#{role}-work", uncollected: false, involved_on_collection_level: false }
          - first = false
        - if role_counts[:uncollected] > 0
          %div{ class: first ? "book-type selected pointer" : "book-type pointer" }
            .truncate{ 'data-bs-toggle' => 'collapse', 'data-bs-target' => "#uncollected-#{role}-collapse", 'data-scroll-target' => "#works-#{role}-uncollected" }
              = t('toc_by_role.uncollected_works')
              %span.count-badge= " (#{role_counts[:uncollected]})"
              %span.collapse-arrow ↓
          %ul{ id: "uncollected-#{role}-collapse", class: first ? 'collapse navbar-nav show' : 'collapse navbar-nav', "aria-label" => "file-navigator", :role => "tree"}
            = render partial: 'shared/navbar/toc_node', collection: [uncollected_node], locals: { role: role, authority_id: authority_id, uncollected: false, involved_on_collection_level: false }
          - first = false

  - if @any_curated
    .nav-book-group.editorial-nav
      .headline-2-v02= t(:curated_content)
      .book-type
        .truncate עדכונים אחרונים
      .book-type
        .truncate יצירות על אודות היוצר
      .book-type
        .truncate קישורים חיצוניים
      .book-type
        .truncate המלצות קוראים
  - if @lexicon_entry.present?
    .nav-book-group.lexicon-background-color
      .headline-2-v02= t(:lexicon_content)
      .book-type
        .truncate תמצית
      .book-type
        .truncate רשימת ספרים
      .book-type
        .truncate על המחבר ויצירתו
      .book-type
        .truncate קישורים

:javascript
  $(document).ready(function() {
    // Initialize arrows based on current collapse state
    $('.collapse.navbar-nav').each(function() {
      var targetId = $(this).attr('id');
      var isExpanded = $(this).hasClass('show');
      $('.truncate[data-bs-target="#' + targetId + '"] .collapse-arrow').text(isExpanded ? '↑' : '↓');
    });

    // Handle clicks on collapsible sections
    // Note: While Bootstrap can auto-handle via data-bs-toggle, we need to manually
    // trigger it here to ensure our scroll timing works correctly with the collapse events
    $('.book-type .truncate[data-bs-toggle="collapse"]').click(function(e) {
      var $trigger = $(this);
      var $collapseTarget = $($trigger.data('bs-target'));
      var scrollTarget = $trigger.data('scroll-target');

      // Set up one-time listener for scroll after collapse animation
      if (scrollTarget && $(scrollTarget).length > 0) {
        $collapseTarget.one('shown.bs.collapse hidden.bs.collapse', function() {
          var headerHeight = $('#header-author').outerHeight() || 0;
          var offset = $(scrollTarget).offset().top - headerHeight - 120;
          $('html, body').animate({
            scrollTop: offset
          }, 500);
        });
      }

      // Manually trigger the collapse
      // (Prevents Bootstrap's automatic handler from also triggering - avoids double-toggle)
      e.preventDefault();
      $collapseTarget.collapse('toggle');
    });

    // Handle clicks on sections without collapse targets (just scroll immediately)
    $('.book-type .truncate').not('[data-bs-toggle="collapse"]').click(function(e) {
      var scrollTarget = $(this).data('scroll-target');
      if (scrollTarget && $(scrollTarget).length > 0) {
        var headerHeight = $('#header-author').outerHeight() || 0;
        var offset = $(scrollTarget).offset().top - headerHeight - 120;
        $('html, body').animate({
          scrollTop: offset
        }, 500);
      }
    });

    // Handle collection anchor links smooth scrolling
    $('.collection-anchor-link').click(function(e) {
      e.preventDefault();
      var target = $(this).attr('href');
      if ($(target).length > 0) {
        var headerHeight = $('#header-author').outerHeight() || 0;
        var offset = $(target).offset().top - headerHeight - 150;
        $('html, body').animate({
          scrollTop: offset
        }, 500);
      }
    });
    $('.nav-link').click(function(e) {
      e.preventDefault();
      //$('.nav-item').removeClass('current-menu-item');
      //$(this).parent().addClass('current-menu-item');
      anchor = $(this).attr('id').replace('_button','_g');
      $('html, body').animate({
        scrollTop: $('a[name='+anchor+']').offset().top - $('#header').height() -65
      }, 800);
    });

    // Toggle collapse arrows
    $('.collapse.navbar-nav').on('show.bs.collapse', function() {
      var targetId = $(this).attr('id');
      $('.truncate[data-bs-target="#' + targetId + '"] .collapse-arrow').text('↑');
    });

    $('.collapse.navbar-nav').on('hide.bs.collapse', function() {
      var targetId = $(this).attr('id');
      $('.truncate[data-bs-target="#' + targetId + '"] .collapse-arrow').text('↓');
    });
  });