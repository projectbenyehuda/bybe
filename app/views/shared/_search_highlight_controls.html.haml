-# Search highlight navigation controls
- if local_assigns[:search_query].present?
  #search-highlight-controls{ style: 'display: none;', data: { search_query: search_query } }
    .search-highlight-info
      %span#current-match 0
      %span /
      %span#total-matches 0
      %span= t(:matches)
    .search-highlight-buttons
      %button.btn.btn-sm.btn-outline-secondary#prev-match
        %span ◀
      %button.btn.btn-sm.btn-outline-secondary#next-match
        %span ▶
      %button.btn.btn-sm.btn-outline-danger#close-highlights
        %span ✕

:javascript
  $(document).ready(function() {
    var $controls = $('#search-highlight-controls');
    var searchQuery = $controls.data('search-query');

    if (searchQuery && searchQuery.trim() !== '') {
      var $textContainer = $('#actualtext');

      // Check if text container exists before proceeding
      if ($textContainer.length === 0) {
        return;
      }

      var currentMatchIndex = 0;
      var totalMatches = 0;

      // Use Mark.js to highlight all occurrences
      $textContainer.mark(searchQuery, {
        separateWordSearch: false,
        accuracy: 'partially',
        diacritics: false,
        done: function() {
          var $marks = $textContainer.find('mark');
          totalMatches = $marks.length;

          if (totalMatches > 0) {
            $controls.show();
            $('#total-matches').text(totalMatches);

            // Add class to current match
            $marks.eq(0).addClass('current-match');
            currentMatchIndex = 0;
            $('#current-match').text(currentMatchIndex + 1);

            // Scroll to first match
            scrollToMatch($marks.eq(0));
          }
        }
      });

      function scrollToMatch($match) {
        if ($match.length > 0) {
          var $header = $('header').first();
          var headerHeight = $header.length > 0 ? $header.outerHeight() : 0;
          var offsetTop = $match.offset().top - headerHeight - 100;
          $('html, body').animate({
            scrollTop: offsetTop
          }, 300);
        }
      }

      function updateCurrentMatch() {
        var $marks = $textContainer.find('mark');
        $marks.removeClass('current-match');
        $marks.eq(currentMatchIndex).addClass('current-match');
        $('#current-match').text(currentMatchIndex + 1);
        scrollToMatch($marks.eq(currentMatchIndex));
      }

      $('#next-match').click(function() {
        var $marks = $textContainer.find('mark');
        if (totalMatches > 0) {
          currentMatchIndex = (currentMatchIndex + 1) % totalMatches;
          updateCurrentMatch();
        }
      });

      $('#prev-match').click(function() {
        var $marks = $textContainer.find('mark');
        if (totalMatches > 0) {
          currentMatchIndex = (currentMatchIndex - 1 + totalMatches) % totalMatches;
          updateCurrentMatch();
        }
      });

      $('#close-highlights').click(function() {
        $textContainer.unmark();
        $controls.hide();
      });
    }
  });
