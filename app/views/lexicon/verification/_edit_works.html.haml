-# Works editing section for verification workbench - Reuses the works management interface from person_works/index
- checklist = @entry.verification_progress&.dig('checklist', 'works') || {}
- work_items = checklist['items'] || {}

:css
  /* Make modal wider when displaying works section */
  #generalDlg:has(#works-section) .modal-dialog {
    max-width: 90vw;
    width: 90vw;
    margin: 1.75rem auto;
  }

  #works-section {
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
  }
  #works-section .table-responsive {
    max-height: 50vh;
    overflow-x: auto;
    overflow-y: auto;
  }
  #works-section table {
    min-width: 100%;
  }
  /* Fix checkbox vertical alignment in table rows */
  #works-section table tbody td {
    vertical-align: middle;
  }
  #works-section .form-check {
    margin-bottom: 0;
    min-height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #works-section .form-check-input {
    margin-top: 0;
    position: static;
    float: none;
  }

#works-section
  - unless @item.authority
    .alert.alert-warning.mb-3
      = t('lexicon.person_works.form.no_authority_warning')

  %a.btn.btn-primary.add-person-work.mb-3= t('lexicon.person_works.index.add_work')

  - if @item.works.any?
    - @item.works.includes(:publication, :collection).group_by(&:work_type).each do |work_type, works|
      %h4= LexPersonWork.human_enum_name(:work_type, work_type)
      .table-responsive
        %table.table.table-sm
          %thead
            %tr
              %th.text-center{ style: 'min-width: 80px;' }
                = t('lexicon.verification.edit.verified')
              %th{ style: 'min-width: 150px;' }= LexPersonWork.human_attribute_name(:title)
              %th{ style: 'min-width: 120px;' }= LexPersonWork.human_attribute_name(:publisher)
              %th{ style: 'min-width: 120px;' }= LexPersonWork.human_attribute_name(:publication_place)
              %th{ style: 'min-width: 100px;' }= LexPersonWork.human_attribute_name(:publication_date)
              %th{ style: 'min-width: 150px;' }= LexPersonWork.human_attribute_name(:publication)
              %th{ style: 'min-width: 150px;' }= LexPersonWork.human_attribute_name(:collection)
              %th{ style: 'min-width: 150px;' }= LexPersonWork.human_attribute_name(:comment)
              %th.text-center{ style: 'min-width: 120px;' }= t(:actions)
          %tbody
            - works.each do |w|
              - work_verified = work_items.dig(w.id.to_s, 'verified') || false
              %tr{ data: { work_id: w.id } }
                %td.text-center
                  .form-check.d-inline-block
                    = check_box_tag "work_verified_#{w.id}", '1', work_verified,
                                    class: 'form-check-input verify-work-checkbox',
                                    data: { work_id: w.id }
                %td= w.title
                %td= w.publisher
                %td= w.publication_place
                %td= w.publication_date
                %td
                  - if w.publication
                    %span{ title: w.publication.title }= w.publication.title
                %td
                  - if w.collection
                    = link_to w.collection.title, collection_path(w.collection),
                              title: w.collection.title,
                              target: '_blank',
                              rel: 'noopener'
                %td= w.comment
                %td.text-center
                  = link_to t(:edit), '#',
                            class: 'edit-person-work btn btn-sm btn-outline-primary me-1',
                            data: { id: w.id }
                  = link_to t(:delete),
                            lexicon_work_path(w),
                            remote: true, data: { confirm: t(:are_you_sure) }, method: :delete,
                            class: 'btn btn-sm btn-outline-danger'
  - else
    .alert.alert-info
      = t('lexicon.verification.edit.no_works')

  %hr.my-4

  .form-check.mt-3
    = check_box_tag :mark_verified, '1', checklist['verified'] || false,
                    class: 'form-check-input',
                    id: 'mark_all_works_verified'
    = label_tag :mark_all_works_verified,
                t('lexicon.verification.edit.mark_all_works_verified'),
                class: 'form-check-label'

  .modal-footer
    %button.btn.btn-secondary{ type: 'button', data: { dismiss: 'modal' } }
      = t('close')

:javascript
  // Initialize works verification interface
  (function() {
    const entryId = #{@entry.id};
    const personId = #{@item.id};

    // Handle individual work verification checkbox changes
    $('.verify-work-checkbox').on('change', function() {
      const checkbox = $(this);
      const workId = checkbox.data('work-id');
      const verified = checkbox.prop('checked');

      $.ajax({
        url: `/lex/verification/${entryId}/update_checklist`,
        type: 'PATCH',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        data: {
          path: `works.items.${workId}`,
          verified: verified,
          notes: ''
        },
        success: function(data) {
          // Update progress bar
          if (typeof updateProgressBar === 'function') {
            updateProgressBar(data.percentage);
          }

          // Check if all individual works are verified
          updateMarkAllCheckbox();
        },
        error: function(xhr) {
          alert('Error updating work verification: ' + (xhr.responseJSON?.error || 'Unknown error'));
          // Revert checkbox
          checkbox.prop('checked', !verified);
        }
      });
    });

    // Handle "Mark all as verified" checkbox
    $('#mark_all_works_verified').on('change', function() {
      const checkbox = $(this);
      const verified = checkbox.prop('checked');

      $.ajax({
        url: `/lex/verification/${entryId}/update_checklist`,
        type: 'PATCH',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        data: {
          path: 'works',
          verified: verified,
          notes: ''
        },
        success: function(data) {
          // Update progress bar and overall checklist
          if (typeof onSectionEditSuccess === 'function') {
            onSectionEditSuccess('section-works')(data);
          }

          // Close modal
          closeModal();

          // Reload page to reflect changes
          setTimeout(() => location.reload(), 500);
        },
        error: function(xhr) {
          alert('Error updating works section: ' + (xhr.responseJSON?.error || 'Unknown error'));
          // Revert checkbox
          checkbox.prop('checked', !verified);
        }
      });
    });

    // Update "Mark all as verified" checkbox based on individual checkboxes
    function updateMarkAllCheckbox() {
      const totalCheckboxes = $('.verify-work-checkbox').length;
      const checkedCheckboxes = $('.verify-work-checkbox:checked').length;

      if (totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes) {
        $('#mark_all_works_verified').prop('checked', true);
      } else {
        $('#mark_all_works_verified').prop('checked', false);
      }
    }

    // Handle add work button
    $('a.add-person-work').click(function(e) {
      e.preventDefault();
      openModal(`/lex/people/${personId}/works/new`, function() {
        // Reload works section after adding
        reloadWorksSection();
      });
    });

    // Handle edit work buttons
    $('.edit-person-work').click(function(e) {
      e.preventDefault();
      const workId = $(this).data('id');
      openModal(`/lex/works/${workId}/edit`, function() {
        // Reload works section after editing
        reloadWorksSection();
      });
    });

    // Reload works section after CRUD operations
    function reloadWorksSection() {
      $.ajax({
        url: `/lex/verification/${entryId}/edit_section`,
        type: 'GET',
        data: { section: 'works' },
        success: function(html) {
          // Replace the modal content with updated works list
          $('#generalDlgBody').html(html);
        },
        error: function(xhr) {
          alert('Error reloading works: ' + (xhr.responseJSON?.error || 'Unknown error'));
        }
      });
    }

    // Initial check of "Mark all" checkbox
    updateMarkAllCheckbox();

    // Reload page when modal closes to update the works section
    $('#generalDlg').one('hidden.bs.modal', function() {
      location.reload();
    });
  })();
