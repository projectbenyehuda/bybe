%a.btn.btn-primary.add-citation= t('.add_citation')
- @lex_citations.group_by(&:subject_title).each do |subject_title, entries|
  %h4= subject_title || t('lexicon.citations.index.no_subject')
  %table.table.table-sm
    %thead
      %tr
        %th
        %th= LexCitation.human_attribute_name(:title)
        %th= t(:actions)
    - tbody_id = "citations_#{subject_title.present? ? subject_title.parameterize : 'no-subject'}"
    %tbody{ id: tbody_id, data: { subject_title: subject_title || '' } }
      - entries.sort_by(&:seqno).each do |c|
        %tr{ id: "citation_#{c.id}", data: { citation_id: c.id } }
          %td.drag-handle{ title: t('.drag_to_reorder'), style: 'cursor: move;' }
            .handle â˜°
          %td= raw render_citation(c)
          %td
            = link_to t(:edit), '#', class: 'edit-citation', data: { id: c.id }
            = link_to t(:delete),
                      lexicon_citation_path(c),
                      remote: true, data: { confirm: t(:are_you_sure) }, method: :delete, class: 'delete-citation'

:javascript
  $('.edit-citation').click(function(e) {
    e.preventDefault();
    const citationId = $(this).data('id');
    openModal(`/lex/citations/${citationId}/edit`);
  });
  $('a.add-citation').click(function() {
    openModal('/lex/people/#{@person.id}/citations/new');
  });

  // Initialize Sortable for each subject_title table
  document.querySelectorAll('[id^="citations_"]').forEach(function(tbody) {
    const subjectTitle = tbody.dataset.subjectTitle;
    Sortable.create(
      tbody,
      {
        handle: '.drag-handle',
        animation: 150,
        onEnd: function(evt) {
          const oldIndex = evt.oldIndex; // zero-based
          const newIndex = evt.newIndex; // zero-based
          if (newIndex !== oldIndex) {
            $.post({
              url: `/lex/citations/${evt.item.dataset.citationId}/reorder`,
              data: {
                new_index: newIndex,
                old_index: oldIndex,
                subject_title: subjectTitle
              },
              error: function(xhr, status, error) {
                const errorMsg = xhr.status == 400 ? xhr.responseText : 'Status ' + xhr.status;
                alert('#{t('.reordering_failed')}\n' + errorMsg);
                reloadContent($('#citations'));
              }
            });
          }
        }
      }
    );
  });
